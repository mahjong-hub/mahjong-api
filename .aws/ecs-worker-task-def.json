{
  "family": "mahjong-api-worker-task",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "1024",
  "memory": "3072",

  "executionRoleArn": "arn:aws:iam::047719630708:role/ecsTaskExecutionRole",
  "taskRoleArn": "arn:aws:iam::047719630708:role/mahjong-ecs-task-role",

  "runtimePlatform": {
    "cpuArchitecture": "X86_64",
    "operatingSystemFamily": "LINUX"
  },

  "containerDefinitions": [
    {
      "name": "worker",
      "image": "047719630708.dkr.ecr.ap-southeast-2.amazonaws.com/mahjong-api:latest",
      "essential": true,

      "command": [
        "celery",
        "-A",
        "mahjong_api",
        "worker",
        "-l",
        "INFO",
        "--concurrency=2"
      ],

      "environment": [
        {
          "name": "DJANGO_SETTINGS_MODULE",
          "value": "mahjong_api.settings"
        },
        {
          "name": "DJANGO_ENV",
          "value": "production"
        },
        {
          "name": "AWS_REGION",
          "value": "ap-southeast-2"
        },
        {
          "name": "CELERY_BROKER_URL",
          "value": "sqs://"
        },
        {
          "name": "CELERY_RESULT_BACKEND",
          "value": "django-db"
        },
        {
          "name": "CELERY_VISIBILITY_TIMEOUT",
          "value": "120"
        },
        {
          "name": "CELERY_TASK_DEFAULT_QUEUE",
          "value": "mahjong-detect-queue"
        },
        {
          "name": "MODEL_DIR",
          "value": "/ml/models"
        }
      ],

      "secrets": [
        {
          "name": "DATABASE_URL",
          "valueFrom": "arn:aws:ssm:ap-southeast-2:047719630708:parameter/mahjong/DATABASE_URL"
        },
        {
          "name": "DJANGO_SECRET_KEY",
          "valueFrom": "arn:aws:ssm:ap-southeast-2:047719630708:parameter/mahjong/DJANGO_SECRET_KEY"
        },
        {
          "name": "CELERY_SQS_QUEUE_URL",
          "valueFrom": "arn:aws:ssm:ap-southeast-2:047719630708:parameter/mahjong/CELERY_SQS_QUEUE_URL"
        },
        {
          "name": "AWS_ACCESS_KEY_ID",
          "valueFrom": "arn:aws:ssm:ap-southeast-2:047719630708:parameter/mahjong/AWS_ACCESS_KEY_ID"
        },
        {
          "name": "AWS_SECRET_ACCESS_KEY",
          "valueFrom": "arn:aws:ssm:ap-southeast-2:047719630708:parameter/mahjong/AWS_SECRET_ACCESS_KEY"
        },
        {
          "name": "AWS_STORAGE_BUCKET_NAME",
          "valueFrom": "arn:aws:ssm:ap-southeast-2:047719630708:parameter/mahjong/AWS_STORAGE_BUCKET_NAME"
        },
        {
          "name": "TILE_DETECTOR_MODEL_NAME",
          "valueFrom": "arn:aws:ssm:ap-southeast-2:047719630708:parameter/mahjong/TILE_DETECTOR_MODEL_NAME"
        },
        {
          "name": "TILE_DETECTOR_MODEL_VERSION",
          "valueFrom": "arn:aws:ssm:ap-southeast-2:047719630708:parameter/mahjong/TILE_DETECTOR_MODEL_VERSION"
        },
        {
          "name": "MODEL_S3_URI",
          "valueFrom": "arn:aws:ssm:ap-southeast-2:047719630708:parameter/mahjong/MODEL_S3_URI"
        }
      ],

      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/mahjong-api",
          "awslogs-region": "ap-southeast-2",
          "awslogs-stream-prefix": "worker"
        }
      }
    }
  ]
}
