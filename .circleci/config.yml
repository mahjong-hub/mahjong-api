version: 2.1

executors:
  python-executor:
    docker:
      - image: cimg/python:3.13

commands:
  install-pipenv-dependencies:
    description: Install pipenv and project dependencies
    steps:
      - run:
          name: Install pipenv and dependencies
          environment:
            PIPENV_YES: "1"
            PIPENV_VENV_IN_PROJECT: "1"
          command: |
            python -m pip install --upgrade pip pipenv setuptools
            pipenv install --dev --deploy

jobs:
  pr_check:
    executor: python-executor
    steps:
      - checkout
      - run:
          name: Check PR (title, labels, assignee + comment)
          command: |
            if [ -z "${CIRCLE_PULL_REQUEST:-}" ]; then
              echo "Not a PR build; skipping PR check"
              exit 0
            fi
            python .circleci/scripts/check_pr.py

  check_migrations:
    executor: python-executor
    steps:
      - checkout
      - install-pipenv-dependencies
      - run:
          name: Check for missing migrations
          command: |
            export DJANGO_SETTINGS_MODULE=mahjong_api.test_settings
            pipenv run python manage.py makemigrations --check --dry-run

  test:
    executor: python-executor
    steps:
      - checkout
      - install-pipenv-dependencies
      - run:
          name: Run tests
          command: |
            export DJANGO_SETTINGS_MODULE=mahjong_api.test_settings
            pipenv run python manage.py test

  lint:
    executor: python-executor
    steps:
      - checkout
      - install-pipenv-dependencies
      - run:
          name: Run linting (ruff)
          command: pipenv run ruff check .

workflows:
  version: 2

  pr_checks_and_ci:
    jobs:
      - pr_check
      - check_migrations:
          requires:
            - pr_check
      - test:
          requires:
            - check_migrations
      - lint:
          requires:
            - pr_check
