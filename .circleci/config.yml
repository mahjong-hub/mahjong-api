version: 2.1

executors:
  python-executor:
    docker:
      - image: cimg/python:3.13

  # Machine executor for tests requiring Docker (testcontainers)
  machine-executor:
    machine:
      image: ubuntu-2404:current
    resource_class: medium

commands:
  install-pipenv-dependencies:
    description: Install pipenv and project dependencies
    steps:
      - run:
          name: Install pipenv and dependencies
          environment:
            PIPENV_YES: "1"
            PIPENV_VENV_IN_PROJECT: "1"
          command: |
            python -m pip install --upgrade pip pipenv setuptools
            pipenv install --dev --deploy

  install-python-machine:
    description: Install Python 3.13 on machine executor
    steps:
      - run:
          name: Install Python 3.13
          command: |
            sudo add-apt-repository -y ppa:deadsnakes/ppa
            sudo apt-get update
            sudo apt-get install -y python3.13 python3.13-venv python3.13-dev
            sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.13 1
            sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.13 1
      - run:
          name: Install pipenv and dependencies
          environment:
            PIPENV_YES: "1"
            PIPENV_VENV_IN_PROJECT: "1"
          command: |
            python -m pip install --upgrade pip pipenv setuptools
            python -m pipenv install --dev --deploy

jobs:
  check_migrations:
    executor: python-executor
    environment:
      DJANGO_ENV: ci
    steps:
      - checkout
      - install-pipenv-dependencies
      - run:
          name: Check for missing migrations
          command: |
            pipenv run python manage.py makemigrations --check --dry-run
      - run:
          name: Run fake migrations to ensure they can be applied
          command: |
            pipenv run python manage.py migrate --fake --noinput

  test:
    executor: machine-executor
    environment:
      DJANGO_ENV: test
    steps:
      - checkout
      - install-python-machine
      - run:
          name: Run tests
          command: |
            python -m pipenv run python manage.py test
          no_output_timeout: 10m

  lint:
    executor: python-executor
    environment:
      DJANGO_ENV: ci
    steps:
      - checkout
      - install-pipenv-dependencies
      - run:
          name: Run linting (ruff)
          command: pipenv run ruff check .

workflows:
  version: 2

  pr_ci:
    jobs:
      - check_migrations
      - test:
          requires:
            - check_migrations
      - lint
