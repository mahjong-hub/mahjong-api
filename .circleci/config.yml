version: 2.1

executors:
  python-executor:
    docker:
      - image: cimg/python:3.13

  machine-executor:
    machine:
      image: ubuntu-2404:current
    resource_class: medium

commands:
  install-fast-deps:
    description: Fast install deps from Pipfile.lock (pip wheel cache)
    parameters:
      dev:
        type: boolean
        default: true
    steps:
      - restore_cache:
          keys:
            - v4-pip-{{ arch }}-{{ checksum "Pipfile.lock" }}
            - v4-pip-{{ arch }}-
      - run:
          name: Install pipenv (for exporting locked requirements)
          command: |
            python -m pip install --upgrade pip setuptools wheel pipenv
      - run:
          name: Export requirements from Pipfile.lock
          command: |
            if [ "<< parameters.dev >>" = "true" ]; then
              python -m pipenv requirements --dev > requirements.txt
            else
              python -m pipenv requirements > requirements.txt
            fi
      - run:
          name: Install dependencies (pip, cached)
          environment:
            PIP_CACHE_DIR: ~/.cache/pip
          command: |
            python -m pip install --cache-dir ~/.cache/pip -r requirements.txt
      - save_cache:
          key: v4-pip-{{ arch }}-{{ checksum "Pipfile.lock" }}
          paths:
            - ~/.cache/pip

  install-python-machine:
    description: Install Python 3.13 on machine executor
    steps:
      - run:
          name: Install Python 3.13 + pip
          command: |
            sudo add-apt-repository -y ppa:deadsnakes/ppa
            sudo apt-get update
            sudo apt-get install -y \
              python3.13 python3.13-venv python3.13-dev

            sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.13 1
            sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.13 1

            # Bootstrap pip for deadsnakes python
            python -m ensurepip --upgrade
            python -m pip install --upgrade pip setuptools wheel

jobs:
  check_migrations:
    executor: python-executor
    environment:
      DJANGO_ENV: ci
    steps:
      - checkout
      - install-fast-deps:
          dev: true
      - run:
          name: Check for missing migrations
          command: |
            python manage.py makemigrations --check --dry-run
      - run:
          name: Run fake migrations to ensure they can be applied
          command: |
            python manage.py migrate --fake --noinput

  test:
    executor: machine-executor
    environment:
      DJANGO_ENV: test
    steps:
      - checkout
      - install-python-machine
      - install-fast-deps:
          dev: true
      - run:
          name: Run tests
          command: |
            python manage.py test
          no_output_timeout: 10m

  lint:
    executor: python-executor
    environment:
      DJANGO_ENV: ci
    steps:
      - checkout
      - install-fast-deps:
          dev: true
      - run:
          name: Run linting (ruff)
          command: ruff check .

workflows:
  version: 2
  pr_ci:
    jobs:
      - check_migrations
      - lint
      - test:
          requires:
            - check_migrations
